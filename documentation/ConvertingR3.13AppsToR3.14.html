<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="Author" content="jba">
</head>

<body>

<center>
<h2>Converting an EPICS R3.13 application to R3.14.1</h2>
</center>

<p><br>
This document describes how to convert a R3.13 vxWorks application so that it
builds with release R3.14.1.  It describes procedures such that:</p>
<ul>
  <li>The application uses the configure rules which are new to R3.14.</li>
</ul>
<ul>
  <li>The OSI (Operating System Independent) features of R3.14 are available,
    i.e. iocCore products can be build for vxWorks as well as other
    platforms, e.g. solaris and linux.</li>
</ul>

<h3>Gnumake clean uninstall</h3>

<p>First do a gnumake clean uninstall in the application's root directory to
remove all files created by earlier builds.</p>

<h3>Create a new R3.14 application</h3>
<pre>mkdir &lt;top&gt;
cd &lt;top&gt;
&lt;full path to 3.14 base&gt;/bin/&lt;host_arch&gt;/makeBaseApp.pl -t example junk
/bin/rm -fr junkApp</pre>

<h3>Copy all *App and iocBoot directories and files to the new &lt;top&gt;
directory</h3>
<pre>cd &lt;oldtop&gt; 
find *App iocBoot -print | cpio -pvmd &lt;fullpath name to new top&gt;</pre>

<h3>Modify &lt;top&gt;/configure/RELEASE</h3>

<p>Copy definitions of external modules excluding EPICS_BASE and
TEMPLATES_TOP from old application RELEASE file. <br>
If sequence programs (*.st or *.stt files) exist in your application, add the
SNCSEQ location definition for the R3.14 seq external module</p>

<p><tt>SNCSEQ =&lt;full path to seq module top&gt;</tt></p>
The R3.14 seq module must exist and be built with EPICS base R3.14.1

<h3>Modify the Makefiles in &lt;top&gt;/*App directories.</h3>

<p>Change <tt>"include $(TOP)/config/CONFIG_APP"</tt> to <tt>"include
$(TOP)/configure/CONFIG"</tt></p>

<p>Change " i<tt>nclude $(TOP)/config/RULES_DIRS</tt>" to  "<tt>include
$(TOP)/configure/RULES_DIRS"</tt></p>

<h3>Modify the Makefiles in &lt;top&gt;/*App/*Db directories.</h3>

<p>Remove existing Makefile <br>
Rename Makefile.Host to Makefile <br>
Modify Makefile as follows:</p>

<p>Change "<tt>TOP=../../.."</tt> to "<tt>TOP=../.."</tt></p>

<p>Change    "i<tt>nclude $(TOP)/config/CONFIG_APP</tt>" to "<tt>include
$(TOP)/configure/CONFIG"</tt></p>

<p>Change "<tt>include $(TOP)/config/RULES.Db" </tt>to <tt>"include
$(TOP)/configure/RULES"</tt></p>

<p>Place all definitions between the include lines.</p>

<p>Place any rules after the last include line.</p>

<h3>Modify the Makefiles in &lt;top&gt;/*App/src directories.</h3>

<p>This is the hardest step. The definitions in Makefile.Host and Makefile.Vx
must be manually converted to the new configure definitions.</p>

<p>First replace Makefile with a template Makefile from base.</p>
<pre>rm Makefile
cp &lt;base&gt;/templates/makeBaseApp/top/exampleApp/src/Makefile .</pre>

<p>This new Make file  has comments explaining how to build the various host
and ioc products. Lets consider some examples</p>
<ul>
  <li>Host programs
    <p>Makefile.Host contains definitions like:</p>
    <pre>PROD += caExample
caExample_SRCS += caExample.c
      </pre>
    <p>In Makefile these are:</p>
    <pre>PROD_HOST += caExample
caExample_SRCS += caExample.c
caExample_LIBS += ca
caExample_LIBS += Com
      </pre>
  </li>
  <li>Record Support - generate xxxRecord.h file
    <p>Makefile.Host (or perhaps Makefile.Vx) contains:</p>
    <pre>RECTYPES += xxxRecord.h
      </pre>
    <p>In Makefile this is:</p>
    <pre>DBDINC += xxxRecord
      </pre>
  </li>
  <li>Generating the .dbd file for all record/device/driver support
    <p>Makefile.Host (or perhaps Makefile.Vx) contains:</p>
    <pre>DBDEXPAND = exampleInclude.dbd
DBDNAME = exampleApp.dbd
      </pre>
    <p>In Makefile this is:</p>
    <pre>DBD += example.dbd
      </pre>
    <p>NOTES: Change exampleApp.dbd to example.dbd in all st.cmd files. Also
    this definition assumes that file exampleInclude.dbd exists.</p>
  </li>
  <li>Create the ioc application:
    <p>Makefile.Vx contains statements like:</p>
    <pre>SRCS.c += ../xxxRecord.c
SRCS.c += ../devXxxSoft.c

LIBOBJS += xxxRecord.o
LIBOBJS += devXxxSoft.o
LIBOBJS += sncExample.o

include ../baseLIBOBJS

LIBNAME = exampleLib
INSTALLS += iocCore seq
      </pre>
    <p>In Makefile these become:</p>
    <pre>PROD_IOC_vxWorks = example
example_SRCS += xxxRecord.c
example_SRCS += devXxxSoft.c
example_SRSC += sncExample.stt
example_SRCS += example_registerRecordDeviceDriver.cpp
example_OBJS_vxWorks += $(EPICS_BASE_BIN)/vxComLibrary

#The following are for sequence programs
example_LIBS += seq
example_LIBS += pv
seq_DIR = $(SNCSEQ_LIB)
pv_DIR = $(SNCSEQ_LIB)

example_LIBS += recIoc
example_LIBS += softDevIoc
example_LIBS += testDevIoc
example_LIBS += iocsh
example_LIBS += miscIoc
example_LIBS += rsrvIoc
example_LIBS += dbtoolsIoc
example_LIBS += asIoc
example_LIBS += dbIoc
example_LIBS += registryIoc
example_LIBS += dbStaticIoc
example_LIBS += ca
example_LIBS += Com
      </pre>
  </li>
</ul>

<p>After these changes are made the following files are no longer needed:
baseLIBOBS, Makefile.Host, and Makefile.Vx</p>

<h3>Modify the Makefiles in &lt;top&gt;/iocBoot directory.</h3>

<p>Change " i<tt>nclude $(TOP)/config/CONFIG_APP" </tt>to "<tt>include
$(TOP)/configure/CONFIG"</tt></p>

<p>Remove the line "<tt>DIRS += $(wildcard *ioc*"</tt></p>

<p>Change <tt>"include $(TOP)/config/RULES.iocBoot" </tt>to "i<tt>nclude
$(TOP)/configure/RULES.iocBoot"</tt></p>

<h3>Modify the Makefiles in &lt;top&gt;/iocBoot/ioc* directories.</h3>

<p>Change <tt>"include $(TOP)/config/CONFIG_APP" </tt>to "<tt>include
$(TOP)/configure/CONFIG"</tt></p>

<p>Change</p>

<p><tt>include ARCH = &lt;old arch specification e.g. mv167&gt;</tt></p>

<p>to</p>

<p>"<tt>include ARCH = &lt;new arch specification e.g.
vxWorks-68040&gt;"</tt></p>

<p>Change "<tt>include $(TOP)/config/RULES.ioc</tt>" to "<tt>include
$(TOP)/configure/RULES.ioc"</tt></p>

<p>If it exists remove the line</p>

<p><tt>buildInstall: cdCommands</tt></p>

<h3>Modify st.cmd in &lt;top&gt;/iocBoot/ioc* directories.</h3>

<p>Remove the lines</p>
<pre>ld &lt; seq
ld &lt; iocCore</pre>

<p>Change "<tt>ld &lt; &lt;libname&gt;Lib</tt>" to "<tt>ld &lt;
&lt;libname&gt;.munch"</tt></p>

<p>Change the statement:</p>

<p><tt>dbLoadDatabase("../../dbd/exampleApp.dbd")</tt> <br>
</p>
to
<pre>dbLoadDatabase("../../dbd/&lt;name&gt;.dbd")
registerRecordDeviceDriver(pdbbase)</pre>

<h3>recGbl calls</h3>

<p>If any source file makes calls to recGbl routines make sure it has <span
style="font-family: courier">"#include "recGbl.h"</span>. If it doesn't the
compiler will issue warning messages and the ioc may issue the message:
"undefined symbol: _recGblSetSevr".</p>

<h3>Record support changes</h3>

<p>The steppermotor, scan, and pid records are no longer in base.  If these
records are not used in your application, comment out references to them in
base.dbd. If these record types are used at your site, they  should be
downloaded and built with base R3.14 by your EPICS administrator. To update
the R3.14 location of these record types in your application you must  add
appropriate module definitions to your application's config/RELEASE file and
change the <tt>LIBOBJS</tt> definitions.</p>

<p>For example add</p>

<p>         <tt>PID=&lt;full path to modules directory&gt;/pid</tt></p>

<p>to config/RELEASE. <br>
Remove</p>

<p>         <tt>LIBOBJS += $(EPICS_BASE_BIN)/pidRecord.o</tt></p>

<p>from baseLIBOBJS, and add</p>

<p></p>

<p><tt>LIBOBJS += $(PID_BIN)/pidRecord.o</tt></p>
to your application src/Makefile.

<p>You should consider changing any existing old steppermotor records to the
new EPICS  motor record  module supported by Beamline Controls and Data
Acquisition at APS.</p>

<h3>RecDynLink.o and devPtSoft changes</h3>

<p>recDynLink.o and devPtSoft.o are no longer in EPICS base and now exist as
separate EPICS modules.You must now add the appropriate module full path
definitions to your application config/RELEASE file, and change
<tt>LIBOBJS</tt> location definition <tt>$(EPICS_BASE_BIN)</tt> to the module
definition bin directory in your application src directory files.  See
"Hardware support changes" below for instructions.</p>

<h3>Hardware support changes</h3>

<p>All hardware support (dev, drv and dbd files) except soft support has been
unbundled from base R3.14. This support includes the files symb.dbd,
drvHp1404a.o, drvEpvxiMsg.o, and drvEpvxi.o. If these are not used by your
application, comment out references to them in base.dbd.</p>

<p>Hardware support now exists as separate EPICS modules. The hardware
support for your site should be downloaded and built with base R3.14 by your
EPICS administrator. You must now add the appropriate module full path
definitions to your application config/RELEASE file, and change
<tt>LIBOBJS</tt> location from <tt>$(EPICS_BASE_BIN) </tt>to the module  bin
directory in your application src directory files.</p>

<p>For example, remove</p>

<p>         <tt>LIBOBJS+=$(EPICS_BASE_BIN)/symb</tt></p>

<p>from baseLIBOBJS and add</p>

<p>         <tt>LIBOBJS+=$(SYMB_BIN)/symb</tt></p>

<p>to your application src/Makefile, <br>
and add the line</p>

<p><tt>SYMB=&lt;full path definition for the built module SYMB&gt;</tt></p>

<p>into your application config/RELEASE file .</p>

<h3>dbLoadtemplate tool changes</h3>

<p>The host tool dbLoadTemplate has been replace by a new EPICS extension,
msi, which should be downloaded and built with base R3.14 by your EPICS
administrator. dbLoadTemplate is still supported on iocs.  If, in your
application, db files are created from template and substitution files you
should  add the definition</p>

<p><tt>EPICS_EXTENSIONS=&lt;full path name to epics extensions
directory&gt;</tt></p>

<p>to your application config/RELEASE file.</p>
<br>
 </body>
</html>
