#!/bin/sh
#
# $Id$
#
# Make Release - Creates an EPICS release
#   By Matthew Needes and Bob Zieman
#
#  MakeRelease [-b]
#
#    [-b] - For fully built release
#
# $Log$
# Revision 1.12  1997/07/23 14:46:55  jba
# Added *bat files.
#
# Revision 1.11  1997/07/01 18:29:17  jba
# Changed  Tar to tar in output filename.
#
# Revision 1.10  1997/01/17 19:59:37  jba
# Use config/CONFIG_BASE_VERSION to get version info.
#
# Revision 1.9  1996/09/04 21:41:36  jba
# Top level dir no longer passed to MakeRelease
#
# Revision 1.8  1996/07/02 13:45:09  jba
# Added dbd and base/config dirs. Removed epics/config and base/rec.
#
# Revision 1.7  1996/06/25 21:54:42  jba
# Command line parm now base dir
#
# Revision 1.6  1996/06/07 19:19:10  jba
# MakeRelease is now in release tar file.
#
# Revision 1.5  1996/03/04 21:03:48  jba
# epicsVersion.h now in src/include.
#
# Revision 1.4  1996/02/20 21:03:53  jba
# Updated README files to reflect directory changes and new installEpics.
#
# Revision 1.3  1995/10/03  15:42:26  jba
# Added *COPYRIGHT* files to release tar file.
#
# Revision 1.2  1995/08/28  15:49:54  jba
# Added startup directory to release tar file
#
# Revision 1.1  1995/08/17  20:14:56  jba
# Added base/tools scripts functionality to base/Makefile, removed scripts
# Moved base/tools/MakeRelease to base dir.
#
# Revision 1.14  1994/12/19  18:42:08  tang
# Make the args length compatible for HP and SUN.
#
# Revision 1.13  1994/12/15  19:19:18  tang
# Replace -I opt by cat and xargs for tar for HP compatibility.
#
# Revision 1.12  1994/12/14  23:57:55  tang
# Take out \< and \> pair for hp compatible
#
# Revision 1.11  1994/10/31  21:44:17  jba
# Moved print stmnt, added cd $(EPICS)
#
# Revision 1.10  1994/10/05  18:29:34  jba
# Renamed version.h to epicsVersion.h
#
# Revision 1.9  1994/09/22  01:41:47  mcn
# MakeRelease - MAJOR bug fix.  GetVar / MakeDirs - minor fix.
#
# Revision 1.8  1994/09/07  20:59:15  mcn
# Revamped GetVar, modified scripts for new GetVar.
#
# Revision 1.7  1994/09/02  20:58:00  mcn
# minor change.
#
# Revision 1.6  1994/08/21  00:56:41  mcn
# New Stuff
#
# Revision 1.5  1994/08/02  18:36:29  mcn
# Support new configuration.
#
# Revision 1.4  1994/07/14  22:13:32  mcn
# Now include SDR Makefile/Headers
#
#


if [ ! -d src ]; then
	echo "Cannot find src directory, are you at the top of EPICS base ?"
	exit 1
fi


FULLY_BUILT=NO
if [ "${1}" = "-b" ]; then
	FULLY_BUILT=YES
	shift
	if [ "${1}" != "." ]; then
		echo "TOP: Cannot create a fully built release.";
		exit 1;
	fi
fi

# Retrieve EPICS release string from config/CONFIG_BASE_VERSION
. config/CONFIG_BASE_VERSION

if [ -z "${EPICS_VERSION}" ];
	then
		echo "TOP:  Cannot retrieve release number from config/CONFIG_BASE_VERSION";
		exit 1;
	fi

RELS="R${EPICS_VERSION}.${EPICS_REVISION}.${EPICS_MODIFICATION}.${EPICS_UPDATE_NAME}${EPICS_UPDATE_LEVEL}";

echo TOP: Creating ../${RELS}.tar;

if [ -f ${RELS}.tar* ];
	then
		echo "TOP: This release has already been created.";
		echo "TOP: Remove tar file or edit config/CONFIG_BASE_VERSION.";
		exit 1;
	fi

# Create list of files and dirs to include in tar file

cd ..

ls base/README* base/*.bat | xargs tar cvf ${RELS}.tar

ls base/Make* > /tmp/make_release.out.$$;

ls base/*COPYRIGHT* >> /tmp/make_release.out.$$;


if [ -d startup ];
	then
		find startup -name CVS -prune -o ! -type d -print \
				>> /tmp/make_release.out.$$;
	fi

# binary / library / default.dctsdr / <rec>Record.h / etc.
if [ $FULLY_BUILT = "YES" ];
	then
		find base/include -name CVS -prune -o ! -type d -print \
				>> /tmp/make_release.out.$$;

		find base/man -name CVS -prune -o ! -type d -print \
				>> /tmp/make_release.out.$$;

		find base/bin -name CVS -prune -o ! -type d -print \
				>> /tmp/make_release.out.$$;

		find base/lib -name CVS -prune -o ! -type d -print \
				>> /tmp/make_release.out.$$;

		find base/dbd -name CVS -prune -o ! -type d -print \
				>> /tmp/make_release.out.$$;

	fi

find base/config -name CVS -prune -o -name SCCS -prune -o ! -type d -print \
		| grep -v '/O\..*$' >> /tmp/make_release.out.$$

find base/src -name CVS -prune -o -name SCCS -prune -o ! -type d -print \
		| grep -v '/O\..*$' >> /tmp/make_release.out.$$

cat /tmp/make_release.out.$$ | xargs tar rvf ${RELS}.tar 
		
rm /tmp/make_release.out.$$

